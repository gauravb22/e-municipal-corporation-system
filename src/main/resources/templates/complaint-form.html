<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Complaint Form | e-Municipal Corporation</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg-a: #0f2f62;
    --bg-b: #25589f;
    --surface: #ffffff;
    --surface-soft: #f6f9ff;
    --text-main: #163152;
    --text-muted: #5e728d;
    --line: #d7e3f2;
    --accent: #1f5faa;
    --accent-strong: #124784;
    --danger-bg: #fceae9;
    --danger-text: #a9291f;
    --success-bg: #eaf8ef;
    --success-text: #187346;
    --shadow: 0 14px 30px rgba(12, 37, 70, 0.2);
    --radius-lg: 18px;
    --radius-md: 14px;
    --radius-sm: 10px;
}

body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
    background:
        radial-gradient(circle at 8% 10%, rgba(105, 176, 242, 0.24), transparent 38%),
        radial-gradient(circle at 90% 14%, rgba(92, 203, 226, 0.22), transparent 42%),
        linear-gradient(145deg, var(--bg-a) 0%, var(--bg-b) 100%);
    color: var(--text-main);
    padding: 20px 12px;
}

.page-shell {
    max-width: 860px;
    margin: 0 auto;
}

.topbar {
    background: rgba(255, 255, 255, 0.93);
    border: 1px solid rgba(255, 255, 255, 0.7);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
}

.topbar-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 20px;
    font-weight: 800;
    color: var(--text-main);
}

.topbar-title .icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: grid;
    place-items: center;
    background: linear-gradient(145deg, var(--accent), #2f73bf);
    color: #fff;
    font-size: 16px;
}

.back-link {
    text-decoration: none;
    border: 1px solid #ccdaee;
    background: #edf4ff;
    color: var(--accent-strong);
    border-radius: 999px;
    padding: 9px 14px;
    font-weight: 700;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.back-link:hover {
    background: #dfeafb;
}

.form-card {
    margin-top: 14px;
    background: var(--surface);
    border-radius: var(--radius-lg);
    border: 1px solid #e5edf8;
    box-shadow: var(--shadow);
    padding: 24px;
}

.complaint-type {
    background: linear-gradient(145deg, #eff5ff, #f8fbff);
    border: 1px solid #d7e3f2;
    border-left: 4px solid var(--accent);
    border-radius: var(--radius-sm);
    padding: 14px;
    margin-bottom: 16px;
}

.complaint-type .label {
    color: #5d6f87;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    font-weight: 700;
    margin-bottom: 6px;
}

.complaint-type .value {
    color: var(--text-main);
    font-size: 19px;
    font-weight: 800;
}

.error-banner {
    margin-bottom: 14px;
    border-radius: var(--radius-sm);
    background: var(--danger-bg);
    color: var(--danger-text);
    border: 1px solid #f5c7c4;
    padding: 10px 12px;
    font-size: 14px;
    font-weight: 600;
}

.section-title {
    margin-bottom: 10px;
    font-size: 15px;
    font-weight: 800;
    color: var(--text-main);
}

.user-info {
    background: #f7fbff;
    border: 1px solid #dce8f7;
    border-radius: var(--radius-md);
    padding: 14px;
    margin-bottom: 16px;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px 12px;
}

.user-info-item {
    background: #fff;
    border: 1px solid #e8eef8;
    border-radius: 10px;
    padding: 10px;
    font-size: 12px;
    color: #6a7f99;
    font-weight: 600;
}

.user-info-item strong {
    display: block;
    margin-top: 5px;
    color: var(--text-main);
    font-size: 14px;
    font-weight: 700;
}

form {
    margin-top: 8px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
}

.form-group {
    margin-bottom: 12px;
}

.form-group.full {
    grid-column: 1 / -1;
}

.form-group label {
    display: block;
    color: var(--text-main);
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 6px;
}

.required {
    color: #cf2a1b;
}

.hint {
    display: block;
    margin-top: 3px;
    color: #6c7f99;
    font-size: 11px;
    font-weight: 500;
}

.form-group input,
.form-group textarea {
    width: 100%;
    border: 1px solid #ccd9ea;
    border-radius: 10px;
    padding: 11px 12px;
    font-size: 14px;
    font-family: "Segoe UI", Arial, sans-serif;
    color: var(--text-main);
    background: #fff;
}

.form-group textarea {
    resize: vertical;
    min-height: 120px;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #6d95c7;
    box-shadow: 0 0 0 3px rgba(47, 115, 191, 0.15);
}

.camera-section,
.date-section {
    border: 1px solid #d6e3f3;
    border-radius: var(--radius-md);
    background: #f7fbff;
    padding: 14px;
    margin-top: 8px;
}

.capture-title {
    color: var(--text-main);
    font-size: 14px;
    font-weight: 800;
    margin-bottom: 10px;
}

.capture-note {
    color: #627892;
    font-size: 12px;
    margin-bottom: 10px;
}

.timestamp-info,
.location-info {
    border-radius: 10px;
    border: 1px solid #dde8f7;
    background: #fff;
    padding: 9px 10px;
    font-size: 12px;
    color: #56708d;
    margin-bottom: 9px;
}

.camera-button {
    width: 100%;
    border: none;
    border-radius: 10px;
    padding: 11px 12px;
    background: linear-gradient(145deg, #cb2a37, #b11f2b);
    color: #fff;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
}

.camera-button:hover {
    filter: brightness(1.05);
}

#photoInput {
    display: none;
}

.camera-preview {
    width: 100%;
    max-height: 360px;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid #d4e2f2;
    display: none;
    margin-top: 10px;
}

.camera-preview.active {
    display: block;
}

.photo-captured {
    margin-top: 10px;
    border-radius: 10px;
    background: var(--success-bg);
    border: 1px solid #cce9d9;
    color: var(--success-text);
    font-size: 13px;
    font-weight: 700;
    padding: 9px 10px;
    display: none;
}

.photo-captured.show {
    display: block;
}

.date-section p {
    color: #5d6f87;
    font-size: 12px;
    margin-top: 6px;
}

.button-group {
    margin-top: 18px;
    display: flex;
    gap: 10px;
}

.btn {
    border: none;
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-cancel {
    flex: 0 0 180px;
    background: #eef3fb;
    color: #365273;
    border: 1px solid #d6e1f1;
}

.btn-submit {
    flex: 1;
    background: linear-gradient(145deg, var(--accent), #2f73bf);
    color: #fff;
}

.btn-submit:hover {
    filter: brightness(1.03);
}

@media (max-width: 760px) {
    .topbar {
        flex-direction: column;
        align-items: flex-start;
    }

    .back-link {
        width: 100%;
        justify-content: center;
    }

    .form-card {
        padding: 16px;
    }

    .user-info {
        grid-template-columns: 1fr;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .button-group {
        flex-direction: column;
    }

    .btn-cancel {
        flex: 1;
    }
}
</style>
</head>

<body th:attr="data-requires-photo=${requiresPhoto}">
<div class="page-shell">
    <div class="topbar">
        <div class="topbar-title">
            <span class="icon"><i class="fa-solid fa-file-circle-plus" aria-hidden="true"></i></span>
            <span>Raise Complaint</span>
        </div>
        <a class="back-link" href="/raise-complaint">
            <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
            Back to Complaint Types
        </a>
    </div>

    <div class="form-card">
        <div class="complaint-type">
            <div class="label">Complaint Type</div>
            <div class="value" th:text="${complaintType}">Complaint Type</div>
        </div>

        <div class="error-banner" th:if="${error != null}" th:text="${error}">
            Validation error
        </div>

        <div class="section-title">Citizen Details</div>
        <div class="user-info">
            <div class="user-info-item">
                Name
                <strong th:text="${user.fullName}">Citizen Name</strong>
            </div>
            <div class="user-info-item">
                Phone
                <strong th:text="${user.phone}">Phone</strong>
            </div>
            <div class="user-info-item">
                Ward Number
                <strong th:text="${user.wardNo != null ? user.wardNo : 'N/A'}">Ward</strong>
            </div>
            <div class="user-info-item">
                Ward Zone
                <strong th:text="${user.wardZone != null ? user.wardZone : 'N/A'}">Zone</strong>
            </div>
        </div>

        <form action="/submit-complaint" method="POST">
            <input type="hidden" name="type" th:value="${complaintType}">

            <div class="section-title">Complaint Details</div>
            <div class="form-grid">
                <div class="form-group full">
                    <label>
                        Location / Area <span class="required">*</span>
                        <span class="hint">Where exactly is the issue?</span>
                    </label>
                    <input type="text" name="location" placeholder="Enter area or landmark" th:value="${user.address}" required>
                </div>

                <div class="form-group">
                    <label>House Number <span class="required">*</span></label>
                    <input type="text" name="houseNo" placeholder="House number or building name" th:value="${user.houseNo}" required>
                </div>

                <div class="form-group">
                    <label>Ward Number <span class="required">*</span></label>
                    <input type="number" name="wardNo" placeholder="Ward number" th:value="${user.wardNo}" min="1" required>
                </div>

                <div class="form-group">
                    <label>Ward Zone <span class="required">*</span></label>
                    <input type="text" name="wardZone" placeholder="Zone code, e.g. A1" th:value="${user.wardZone}" required>
                </div>

                <div class="form-group full">
                    <label>
                        Detailed Description
                        <span class="hint">Add useful details, timing, and impact. (Optional)</span>
                    </label>
                    <textarea name="description" placeholder="Describe the complaint in detail"></textarea>
                </div>
            </div>

            <div class="date-section" th:if="${requiresNotComingDate}">
                <div class="capture-title">Not Coming From Date</div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Select Date <span class="required">*</span></label>
                    <input type="date" name="notComingFromDate" th:value="${param.notComingFromDate}" required>
                </div>
                <p>Photo upload is not required for this complaint type.</p>
            </div>

            <div class="camera-section" th:if="${requiresPhoto}">
                <div class="capture-title">Complaint Photo <span class="required">*</span></div>
                <p class="capture-note">
                    Capture a live photo from camera. Timestamp and current location are attached automatically.
                </p>

                <div class="timestamp-info">
                    <i class="fa-regular fa-clock" aria-hidden="true"></i>
                    <strong> Timestamp:</strong>
                    <span id="timestampDisplay">--:--:--</span>
                </div>

                <div class="location-info">
                    <i class="fa-solid fa-location-dot" aria-hidden="true"></i>
                    <strong> Location:</strong>
                    <span id="locationDisplay">Fetching GPS...</span>
                </div>

                <button type="button" class="camera-button" onclick="capturePhoto()">
                    <i class="fa-solid fa-camera" aria-hidden="true"></i>
                    Capture Photo from Camera
                </button>

                <img id="photoPreview" class="camera-preview" alt="Captured photo preview">
                <div class="photo-captured" id="photoCapturedMsg">
                    <i class="fa-solid fa-circle-check" aria-hidden="true"></i>
                    Photo captured successfully.
                </div>

                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhotoCapture(event)">
                <input type="hidden" id="photoTimestamp" name="photoTimestamp">
                <input type="hidden" id="photoLocation" name="photoLocation">
                <input type="hidden" id="photoLatitude" name="photoLatitude">
                <input type="hidden" id="photoLongitude" name="photoLongitude">
                <input type="hidden" id="photoBase64" name="photoBase64">
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-cancel" onclick="history.back()">
                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                    Cancel
                </button>
                <button type="submit" class="btn btn-submit">
                    <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
                    Submit Complaint
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const requiresPhoto = document.body.getAttribute('data-requires-photo') === 'true';
const notComingDateInput = document.querySelector('input[name="notComingFromDate"]');

function updateTimestamp() {
    const now = new Date();
    const timestamp = now.toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });
    const timestampDisplay = document.getElementById('timestampDisplay');
    const photoTimestamp = document.getElementById('photoTimestamp');
    if (timestampDisplay) {
        timestampDisplay.textContent = timestamp;
    }
    if (photoTimestamp) {
        photoTimestamp.value = now.toISOString();
    }
}

if (requiresPhoto) {
    setInterval(updateTimestamp, 1000);
    updateTimestamp();
}

function getLocation() {
    if (!navigator.geolocation) {
        return;
    }
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);
            const accuracy = position.coords.accuracy.toFixed(0);

            const photoLatitude = document.getElementById('photoLatitude');
            const photoLongitude = document.getElementById('photoLongitude');
            const photoLocation = document.getElementById('photoLocation');
            const locationDisplay = document.getElementById('locationDisplay');

            if (photoLatitude) {
                photoLatitude.value = lat;
            }
            if (photoLongitude) {
                photoLongitude.value = lon;
            }
            if (photoLocation) {
                photoLocation.value = lat + ", " + lon;
            }
            if (locationDisplay) {
                locationDisplay.textContent = lat + ", " + lon + " (+/-" + accuracy + "m)";
            }
        },
        function(error) {
            console.error('Geolocation error:', error);
            const locationDisplay = document.getElementById('locationDisplay');
            if (locationDisplay) {
                locationDisplay.textContent = 'Location not available';
            }
        }
    );
}

if (requiresPhoto) {
    getLocation();
}

function capturePhoto() {
    const photoInput = document.getElementById('photoInput');
    if (photoInput) {
        photoInput.click();
    }
}

function handlePhotoCapture(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const photoPreview = document.getElementById('photoPreview');
        const photoCapturedMsg = document.getElementById('photoCapturedMsg');
        const photoBase64 = document.getElementById('photoBase64');

        if (photoPreview) {
            photoPreview.src = e.target.result;
            photoPreview.classList.add('active');
        }
        if (photoCapturedMsg) {
            photoCapturedMsg.classList.add('show');
        }
        if (photoBase64) {
            photoBase64.value = e.target.result;
        }
    };
    reader.readAsDataURL(file);
}

const complaintForm = document.querySelector('form');
if (complaintForm) {
    complaintForm.addEventListener('submit', function(e) {
        const photoBase64 = document.getElementById('photoBase64');
        if (requiresPhoto && (!photoBase64 || !photoBase64.value)) {
            e.preventDefault();
            alert('Please capture a photo before submitting.');
            return false;
        }
        if (!requiresPhoto && (!notComingDateInput || !notComingDateInput.value)) {
            e.preventDefault();
            alert('Please select not coming from date before submitting.');
            return false;
        }
        return true;
    });
}
</script>
</body>
</html>
