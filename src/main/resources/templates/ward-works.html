<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Ward Works Feed</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{margin:0;font-family:"Segoe UI", Arial;background:#f5f6f8;min-height:100vh;color:#111;}
.topbar{background:white;color:#0f2f22;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,.08);position:sticky;top:0;z-index:10;}
.brand{display:flex;align-items:center;gap:12px;}
.brand img{width:42px;height:42px;}
.container{max-width:980px;margin:20px auto;padding:12px;}
.card{background:white;border-radius:16px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.08);border:1px solid #eef1f4;} 
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-group{margin-bottom:10px;}
label{display:block;font-size:13px;color:#1f6f4a;margin-bottom:6px;font-weight:600;}
input,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #d9dee5;font-size:14px;}
textarea{min-height:90px;resize:vertical;}
.btn{border:none;border-radius:10px;padding:10px 14px;background:#1f6f4a;color:white;font-weight:600;cursor:pointer;}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap;background:white;border-radius:14px;padding:12px 14px;box-shadow:0 6px 18px rgba(0,0,0,.08);margin-top:16px;margin-bottom:10px;border:1px solid #eef1f4;}
.filter-label{font-size:12px;color:#6b7280;font-weight:600;letter-spacing:.3px;}
.filter-select{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:13px;background:#fafafa;}
.feed{margin-top:12px;display:grid;gap:18px;}
.post{background:white;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08);overflow:hidden;border:1px solid #eef1f4;}
.post-header{display:flex;align-items:center;gap:10px;padding:14px 16px;}
.profile{width:44px;height:44px;border-radius:50%;border:2px solid #e5e7eb;object-fit:cover;background:#f2f2f2;}
.name{font-weight:700;color:#111;}
.meta{font-size:12px;color:#6b7280;}
.post-body{padding:0 16px 12px;}
.post-img{width:100%;max-height:520px;object-fit:cover;background:#f3f4f6;}
.post-title{font-weight:700;color:#111;margin-top:12px;}
.post-text{margin-top:6px;color:#374151;font-size:14px;line-height:1.5;}
.actions{display:flex;align-items:center;gap:10px;padding:10px 16px;}
.icon-btn{border:none;background:transparent;cursor:pointer;padding:0;display:flex;align-items:center;gap:6px;font-size:18px;}
.icon-btn.disabled{opacity:.5;cursor:not-allowed;}
.icon-heart{color:#111;}
.icon-heart.liked{color:#e11d48;}
.icon-count{font-size:12px;color:#6b7280;font-weight:600;}
.rating{display:flex;gap:6px;align-items:center;padding:8px 16px 12px;}
.star{cursor:pointer;color:#e5e7eb;font-size:20px;}
.star.active{color:#f6b100;}
.note{font-size:12px;color:#6b6b6b;margin-top:6px;}
.danger{background:#ffe5e5;}

/* ================= UPLOAD MODAL ================= */
.upload-trigger{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
}
.upload-trigger h3{margin:0;}
.upload-btn{
    background:#1f6f4a;
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:12px;
    font-weight:600;
    cursor:pointer;
}
.modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:200;
}
.modal-overlay.show{display:flex;}
.modal{
    width:min(900px, 92vw);
    background:white;
    border-radius:18px;
    padding:18px;
    box-shadow:0 18px 40px rgba(0,0,0,.35);
}
.modal-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
}
.modal-title{font-weight:700;color:#0e2f22;}
.close-btn{
    border:none;
    background:#f3f5f9;
    border-radius:10px;
    width:36px;
    height:36px;
    cursor:pointer;
    font-weight:700;
}
</style>
</head>
<body>
<div class="topbar">
    <div class="brand">
        <img src="/images/municipalLogo.png" alt="Logo">        
        <div>
            <div style="font-weight:700;">Akola Mahanagarpalika</div>
            <div style="font-size:12px;opacity:.85;">Ward Works Feed</div>
        </div>
    </div>
    <a href="/ward-dashboard" style="color:#0f2f22;text-decoration:none;font-weight:600;">Back</a>
</div>

<div class="container">
    <div class="card" th:if="${staffUser != null}">
        <div class="upload-trigger">
            <h3>Upload Your Ward Works</h3>
            <button class="upload-btn" type="button" onclick="openUploadModal()">Post Work</button>
        </div>
        <div class="note">Share completed ward work updates with citizens.</div>
    </div>

    <div class="modal-overlay" id="uploadModal" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Post Ward Work</div>
                <button class="close-btn" type="button" onclick="closeUploadModal()">×</button>
            </div>
            <form method="post" action="/ward-works/create">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" name="title" placeholder="Work title" required>
                    </div>
                    <div class="form-group">
                        <label>Work Done Date</label>
                        <input type="date" name="workDoneDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ward No</label>
                        <input type="number" name="wardNo" th:value="${staffUser.wardNo}" required>
                    </div>
                    <div class="form-group">
                        <label>Ward Zone</label>
                        <input type="text" name="wardZone" th:value="${staffUser.wardZone}" required>
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Address</label>
                        <input type="text" name="address" placeholder="Work address" required>
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Description</label>
                        <textarea name="description" placeholder="Describe work done" required></textarea>
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Upload Photo</label>
                        <input type="file" id="workPhoto" accept="image/*" onchange="handleWorkPhoto(event)" required>
                        <input type="hidden" id="imageBase64" name="imageBase64">
                    </div>
                </div>
                <div class="note">Done by: <strong th:text="${staffUser.fullName != null && !#strings.isEmpty(staffUser.fullName) ? staffUser.fullName : 'Ward Member'}">Ward Member</strong> (auto)</div>
                <button class="btn" type="submit">Publish Post</button>
            </form>
        </div>
    </div>

    <div class="filter-bar">
        <div>
            <div class="filter-label">Filter</div>
            <select class="filter-select" id="filterAll">
                <option value="all">All Posts</option>
            </select>
        </div>
        <div>
            <div class="filter-label">Ward No</div>
            <select class="filter-select" id="filterWard">
                <option value="all">All Wards</option>
            </select>
        </div>
        <div>
            <div class="filter-label">Zone</div>
            <select class="filter-select" id="filterZone">
                <option value="all">All Zones</option>
            </select>
        </div>
    </div>

    <div class="feed">
        <div class="post" th:each="p : ${posts}" th:attr="data-ward=${p.wardNo},data-zone=${p.wardZone}">
            <div class="post-header">
                <img class="profile" th:src="${postPhotos[p.id] != null ? postPhotos[p.id] : '/images/ward-member.png'}" alt="Ward Member">
                <div>
                    <div class="name" th:text="${postOwnerNames[p.id] != null ? postOwnerNames[p.id] : 'Ward Member'}">Ward Member</div>
                    <div class="meta">Ward <span th:text="${p.wardNo}">-</span> • Zone <span th:text="${p.wardZone}">-</span> • <span th:text="${p.createdAt != null ? #temporals.format(p.createdAt, 'dd-MMM-yyyy HH:mm') : 'N/A'}">--</span></div>
                </div>
            </div>

            <img class="post-img" th:if="${p.imageBase64 != null}" th:src="${p.imageBase64}" alt="Work photo">
            <div class="post-body">
                <div class="post-title" th:text="${p.title}">Title</div>
                <div class="meta" th:text="${p.address}">Address</div>
                <div class="post-text" th:text="${p.description}">Description</div>
                <div class="meta" style="margin-top:8px;">Work Done: <span th:text="${p.workDoneDate != null ? p.workDoneDate : 'N/A'}">--</span></div>
            </div>

            <div class="actions" th:if="${user != null}">
                <form method="post" th:action="'/ward-works/' + ${p.id} + '/like'">
                    <button class="icon-btn" type="submit"
                            th:classappend="${userLiked[p.id]} ? ' disabled' : ''"
                            th:disabled="${userLiked[p.id]}">
                        <i class="fa-heart icon-heart" th:classappend="${userLiked[p.id]} ? ' fa-solid liked' : ' fa-regular'"></i>
                    </button>
                </form>
                <span class="icon-count" th:text="${likeCounts[p.id]} ?: 0">0</span>
                <div class="meta">Avg <span th:text="${avgRatings[p.id]} ?: 0.0">0.0</span>/5</div>
            </div>

            <div class="rating" th:if="${user != null}">
                <form method="post" th:action="'/ward-works/' + ${p.id} + '/rate'" th:id="'rateForm-' + ${p.id}">
                    <input type="hidden" name="rating" th:id="'rating-' + ${p.id}" value="0">
                    <span class="star" th:attr="data-work=${p.id}" data-value="1"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                    <span class="star" th:attr="data-work=${p.id}" data-value="2"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                    <span class="star" th:attr="data-work=${p.id}" data-value="3"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                    <span class="star" th:attr="data-work=${p.id}" data-value="4"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                    <span class="star" th:attr="data-work=${p.id}" data-value="5"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                </form>
            </div>

            <div class="note" th:if="${userRatings[p.id] != null}">Your Rating: <span th:text="${userRatings[p.id]}">0</span>/5</div>

            <div th:if="${staffUser != null}" class="comment-box">
                <form method="post" th:action="'/ward-works/' + ${p.id} + '/edit'">
                    <input type="text" name="title" th:value="${p.title}" placeholder="Edit title" required>
                    <input type="text" name="description" th:value="${p.description}" placeholder="Edit description" required>
                    <button class="action-btn" type="submit">Save</button>
                </form>
                <form method="post" th:action="'/ward-works/' + ${p.id} + '/delete'">
                    <button class="action-btn danger" type="submit">Delete Post</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function handleWorkPhoto(event){
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
        document.getElementById('imageBase64').value = e.target.result;
    };
    reader.readAsDataURL(file);
}

function openUploadModal(){
    const modal = document.getElementById('uploadModal');
    if (!modal) return;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
}

function closeUploadModal(){
    const modal = document.getElementById('uploadModal');
    if (!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeUploadModal();
    }
});

const uploadModal = document.getElementById('uploadModal');
if (uploadModal) {
    uploadModal.addEventListener('click', (e) => {
        if (e.target === uploadModal) {
            closeUploadModal();
        }
    });
}

document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', function(){
        const workId = this.getAttribute('data-work');
        const value = this.getAttribute('data-value');
        document.getElementById('rating-' + workId).value = value;
        const form = document.getElementById('rateForm-' + workId);
        const stars = document.querySelectorAll('.star[data-work="' + workId + '"]');
        stars.forEach(s => {
            if (s.getAttribute('data-value') <= value) {
                s.classList.add('active');
            } else {
                s.classList.remove('active');
            }
        });
        if (form) form.submit();
    });
});

const wardSelect = document.getElementById('filterWard');
const zoneSelect = document.getElementById('filterZone');
const allSelect = document.getElementById('filterAll');
const posts = Array.from(document.querySelectorAll('.post'));

function buildFilters() {
    const wards = new Set();
    const zones = new Set();
    posts.forEach(p => {
        const w = p.getAttribute('data-ward');
        const z = p.getAttribute('data-zone');
        if (w) wards.add(w);
        if (z) zones.add(z);
    });
    Array.from(wards).sort((a,b) => Number(a) - Number(b)).forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.textContent = w;
        wardSelect.appendChild(opt);
    });
    Array.from(zones).sort().forEach(z => {
        const opt = document.createElement('option');
        opt.value = z;
        opt.textContent = z;
        zoneSelect.appendChild(opt);
    });
}

function applyFilters() {
    const ward = wardSelect.value;
    const zone = zoneSelect.value;
    posts.forEach(p => {
        const matchWard = ward === 'all' || p.getAttribute('data-ward') === ward;
        const matchZone = zone === 'all' || p.getAttribute('data-zone') === zone;
        p.style.display = (matchWard && matchZone) ? '' : 'none';
    });
}

if (wardSelect && zoneSelect && allSelect) {
    buildFilters();
    wardSelect.addEventListener('change', applyFilters);
    zoneSelect.addEventListener('change', applyFilters);
    allSelect.addEventListener('change', () => {
        wardSelect.value = 'all';
        zoneSelect.value = 'all';
        applyFilters();
    });
}
</script>
</body>
</html>
