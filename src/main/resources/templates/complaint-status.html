<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Complaint Status | e-Municipal Corporation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <link rel="stylesheet" href="/css/complaint-status.css">
</head>
<body>
    <div class="page-shell">
        <div class="topbar">
            <div class="topbar-title">
                <span class="icon"><i class="fa-regular fa-clipboard" aria-hidden="true"></i></span>
                <span>Complaint Status</span>
            </div>
            <a href="/dashboard" class="back-btn">
                <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
                Back to Dashboard
            </a>
        </div>

        <div class="summary">
            <span>Total complaints: <b th:text="${complaints != null ? #lists.size(complaints) : 0}">0</b></span>
            <span class="muted">Track updates, escalate overdue cases, and submit feedback for completed work.</span>
        </div>

        <div th:if="${complaints.isEmpty()}">
            <div class="empty-state">
                <p>No complaints filed yet.</p>
                <a href="/raise-complaint" class="cta">
                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                    File a New Complaint
                </a>
            </div>
        </div>

        <div class="complaints" th:if="${!complaints.isEmpty()}">
            <article th:each="complaint : ${complaints}" class="complaint-card">
                <div class="complaint-header">
                    <div>
                        <div class="complaint-title" th:text="${complaint.complaintType}">Complaint Type</div>
                        <div class="complaint-id">Complaint #<span th:text="${complaint.id}">0</span></div>
                    </div>

                    <span class="status-badge"
                          th:classappend="${' ' + complaintService.getStatusBadgeClass(complaint.status)}"
                          th:text="${complaintService.getStatusLabel(complaint.status)}">
                        SUBMITTED
                    </span>
                </div>

                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label"><i class="fa-solid fa-location-dot" aria-hidden="true"></i> Location</div>
                        <div class="detail-value" th:text="${complaint.location}">Location</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label"><i class="fa-solid fa-house" aria-hidden="true"></i> House Number</div>
                        <div class="detail-value" th:text="${complaint.houseNo}">House</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label"><i class="fa-regular fa-calendar" aria-hidden="true"></i> Date Filed</div>
                        <div class="detail-value" th:text="${#temporals.format(complaint.createdAt, 'dd-MMM-yyyy HH:mm')}">Date</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label"><i class="fa-regular fa-clock" aria-hidden="true"></i> Status Updated</div>
                        <div class="detail-value"
                             th:text="${complaint.updatedAt != null ? #temporals.format(complaint.updatedAt, 'dd-MMM-yyyy HH:mm') : 'Not updated yet'}">
                            Not updated yet
                        </div>
                    </div>
                    <div class="detail-item" th:if="${complaint.notComingFromDate != null}">
                        <div class="detail-label"><i class="fa-regular fa-calendar-days" aria-hidden="true"></i> Not Coming From</div>
                        <div class="detail-value" th:text="${#temporals.format(complaint.notComingFromDate, 'dd-MMM-yyyy')}">Date</div>
                    </div>
                </div>

                <div class="description-box" th:if="${complaint.description != null && !#strings.isEmpty(complaint.description)}">
                    <div class="label"><i class="fa-regular fa-pen-to-square" aria-hidden="true"></i> Description</div>
                    <div class="value" th:text="${complaint.description}">Description text</div>
                </div>

                <div class="photos-wrap" th:if="${complaint.photoPath != null || complaint.photoBase64 != null || complaint.donePhotoPath != null || complaint.donePhotoBase64 != null}">
                    <div class="photo-panel" th:if="${complaint.photoPath != null || complaint.photoBase64 != null}">
                        <h4><i class="fa-solid fa-camera" aria-hidden="true"></i> Complaint Photo</h4>
                        <div class="photo-meta"><strong>Captured:</strong> <span th:text="${complaint.photoTimestamp}">-</span></div>
                        <div class="photo-meta"><strong>Location:</strong> <span th:text="${complaint.photoLocation}">-</span></div>
                        <img class="complaint-photo"
                             th:src="${complaint.photoPath != null ? complaint.photoPath : complaint.photoBase64}"
                             alt="Complaint photo">
                    </div>

                    <div class="photo-panel" th:if="${complaint.donePhotoPath != null || complaint.donePhotoBase64 != null}">
                        <h4><i class="fa-solid fa-circle-check" aria-hidden="true"></i> Work Completed Photo</h4>
                        <div class="photo-meta"><strong>Captured:</strong> <span th:text="${complaint.donePhotoTimestamp}">-</span></div>
                        <div class="photo-meta">
                            <strong>Location:</strong>
                            <a th:if="${complaint.donePhotoLatitude != null && complaint.donePhotoLongitude != null && complaint.donePhotoLatitude != '0' && complaint.donePhotoLongitude != '0'}"
                               th:href="'https://www.google.com/maps?q=' + ${complaint.donePhotoLatitude} + ',' + ${complaint.donePhotoLongitude}"
                               target="_blank" rel="noopener"
                               th:text="${complaint.donePhotoLocation}">Open Map</a>
                            <span th:if="${complaint.donePhotoLatitude == null || complaint.donePhotoLongitude == null || complaint.donePhotoLatitude == '0' || complaint.donePhotoLongitude == '0'}"
                                  th:text="${complaint.donePhotoLocation}">Location</span>
                        </div>
                        <img class="complaint-photo"
                             th:src="${complaint.donePhotoPath != null ? complaint.donePhotoPath : complaint.donePhotoBase64}"
                             alt="Completed work photo">
                    </div>
                </div>

                <div th:if="${complaint.status == 'submitted' || complaint.status == 'pending' || complaint.status == 'overdue'}">
                    <div class="time-remaining" th:id="'time-' + ${complaint.id}">
                        <i class="fa-regular fa-clock" aria-hidden="true"></i>
                        Time remaining:
                        <span th:text="${complaintService.getTimeRemaining(complaint)}">0 hours</span>
                    </div>

                    <form method="POST" th:action="'/escalate-complaint/' + ${complaint.id}">
                        <button type="submit" class="escalation-btn" th:if="${complaintService.isPendingFor72Hours(complaint)}">
                            <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
                            Escalate - 72+ Hours Pending
                        </button>
                    </form>
                </div>

                <section th:if="${complaint.status == 'completed' || complaint.status == 'verified' || complaint.status == 'solved'}" class="feedback-section">
                    <h4><i class="fa-regular fa-comment-dots" aria-hidden="true"></i> Complaint Feedback</h4>

                    <div th:if="${complaint.feedbackSubmitted}" class="feedback-submitted">
                        <h5><i class="fa-solid fa-check" aria-hidden="true"></i> Feedback Submitted</h5>
                        <p>
                            <strong>Solved:</strong>
                            <span th:if="${complaint.feedbackSolved}">Yes</span>
                            <span th:if="${!complaint.feedbackSolved}">No</span>
                        </p>
                        <p th:if="${complaint.feedbackRating != null}">
                            <strong>Rating:</strong>
                            <span class="submitted-stars">
                                <i class="fa-solid fa-star" th:each="i : ${#numbers.sequence(1, complaint.feedbackRating)}" aria-hidden="true"></i>
                            </span>
                            <span th:text="${complaint.feedbackRating} + ' / 5'">0 / 5</span>
                        </p>
                        <p th:if="${complaint.feedbackRating == null}">
                            <strong>Rating:</strong> Not provided
                        </p>
                        <p><strong>Feedback:</strong> <span th:text="${complaint.feedbackDescription}">Feedback text</span></p>
                        <p th:if="${complaint.feedbackSolvedBy != null && !complaint.feedbackSolvedBy.isEmpty()}">
                            <strong>Solved By:</strong> <span th:text="${complaint.feedbackSolvedBy}">Name</span>
                        </p>
                        <p class="muted">
                            Submitted:
                            <span th:text="${complaint.feedbackSubmittedAt != null ? #temporals.format(complaint.feedbackSubmittedAt, 'dd-MMM-yyyy HH:mm') : '-'}">-</span>
                        </p>
                    </div>

                    <div th:if="${complaint.feedbackSubmitted == null || !complaint.feedbackSubmitted}">
                        <p class="muted" style="margin-bottom: 10px;">
                            Please share your feedback about the resolution quality.
                        </p>

                        <form class="feedback-form" method="POST" th:action="'/submit-feedback/' + ${complaint.id}">
                            <div class="form-group">
                                <label><i class="fa-solid fa-check" aria-hidden="true"></i> Is your complaint solved?</label>
                                <select name="solved" required>
                                    <option value="">-- Select --</option>
                                    <option value="true">Yes, fully solved</option>
                                    <option value="false">No, still not solved</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label><i class="fa-regular fa-pen-to-square" aria-hidden="true"></i> Feedback Description</label>
                                <textarea name="description" placeholder="Share your experience and suggestions..." required></textarea>
                            </div>

                            <div class="form-group">
                                <label><i class="fa-solid fa-star" aria-hidden="true"></i> Rating</label>
                                <div class="star-rating" th:attr="data-complaint-id=${complaint.id}">
                                    <span class="star" data-value="1"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                                    <span class="star" data-value="2"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                                    <span class="star" data-value="3"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                                    <span class="star" data-value="4"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                                    <span class="star" data-value="5"><i class="fa-solid fa-star" aria-hidden="true"></i></span>
                                </div>
                                <input type="hidden" name="rating" th:id="'ratingValue-' + ${complaint.id}" value="0" required>
                            </div>

                            <div class="button-group">
                                <button type="submit" class="btn">Submit Feedback</button>
                            </div>
                        </form>
                    </div>
                </section>
            </article>
        </div>
    </div>

    
    <script src="/js/complaint-status.js"></script>
</body>
</html>

