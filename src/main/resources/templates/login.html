<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
    <style>
        :root{
            --citizen-bg1:#1e3c72;
            --citizen-bg2:#2a5298;
            --ward-bg1:#0f3d2e;
            --ward-bg2:#2e8b57;
            --admin-bg1:#2b1a0f;
            --admin-bg2:#9b5a13;

            --citizen-accent:#1e3c72;
            --ward-accent:#1f6f4a;
            --admin-accent:#7a3e0b;
        }
        body {
            margin: 0;
            height: 100vh;
            background: linear-gradient(135deg, var(--citizen-bg1), var(--citizen-bg2));
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Segoe UI, Arial;
            transition: background 0.4s ease;
        }
        body.role-ward{
            background: linear-gradient(135deg, var(--ward-bg1), var(--ward-bg2));
        }
        body.role-admin{
            background: linear-gradient(135deg, var(--admin-bg1), var(--admin-bg2));
        }
        .card {
            width: 420px;
            background: #fff;
            padding: 28px;
            border-radius: 18px;
            box-shadow: 0 12px 30px rgba(0,0,0,.15);
            position: relative;
        }
        body.role-ward .card{
            border: 2px solid #bfe6cf;
        }
        body.role-admin .card{
            border: 2px solid #f0d1b1;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo {
            height: 60px;
            width: auto;
        }
        h2 {
            text-align: center;
            color: var(--citizen-accent);
            margin-top: 10px;
            margin-bottom: 8px;
        }
        body.role-ward h2{color: var(--ward-accent);}
        body.role-admin h2{color: var(--admin-accent);}
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 500;
            color: #333;
            text-align: center;
            font-size: 14px;
        }
        .faint {
            color: #b0b0b0;
            font-weight: 400;
            display: block;
            margin-top: 4px;
        }
        .phone-boxes {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .phone-boxes input {
            width: 32px;
            height: 44px;
            font-size: 18px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .phone-boxes input:focus {
            outline: none;
            border-color: var(--citizen-accent);
            box-shadow: 0 0 8px rgba(30, 60, 114, 0.3);
        }
        body.role-ward .phone-boxes input:focus{
            border-color: var(--ward-accent);
            box-shadow: 0 0 8px rgba(31, 111, 74, 0.3);
        }
        body.role-admin .phone-boxes input:focus{
            border-color: var(--admin-accent);
            box-shadow: 0 0 8px rgba(122, 62, 11, 0.3);
        }
        .status {
            text-align: center;
            font-size: 14px;
            margin-top: 15px;
            min-height: 20px;
        }
        .loading { color: var(--citizen-accent); font-weight: 500; }
        body.role-ward .loading{color: var(--ward-accent);} 
        body.role-admin .loading{color: var(--admin-accent);} 
        .error { color: red; font-weight: 500; }
        .success { color: green; font-weight: 500; }
        .signup-link {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
        }
        .signup-link a {
            color: var(--citizen-accent);
            text-decoration: none;
        }
        .signup-link a:hover { text-decoration: underline; }

        .menu-btn{
            position:absolute;
            top:14px;
            right:14px;
            width:36px;
            height:36px;
            border:none;
            border-radius:10px;
            background:#f1f5fb;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:18px;
            color:#2b3a55;
        }

        /* Sidebar */
        .sidebar{
            position:fixed;
            top:0;
            left:-100%;
            width:280px;
            max-width:85vw;
            height:100vh;
            background:white;
            box-shadow:4px 0 20px rgba(0,0,0,.3);
            transition:.3s;
            z-index:100;
            padding:18px 16px;
            overflow-y:auto;
        }
        .sidebar.open{left:0;}
        .sidebar h3{margin:0 0 12px;color:#24324a;}
        .role-btn{
            width:100%;
            border:none;
            border-radius:12px;
            padding:12px 12px;
            text-align:left;
            margin-bottom:10px;
            cursor:pointer;
            background:#f3f5f9;
            color:#1f2a3a;
            font-weight:600;
        }
        .role-btn small{display:block;font-weight:400;color:#5f6b7a;margin-top:4px;}
        .role-btn.active{background:#e8eefb;border:1px solid #c5d5f3;}

        .overlay{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.45);
            display:none;
            z-index:90;
        }
        .overlay.show{display:block;}
        @media (max-width: 480px){
            .sidebar{width:85vw; max-width:85vw;}
        }
    </style>
</head>
<body class="role-citizen">
<div class="sidebar" id="sidebar">
    <h3>Select Login Role</h3>
    <button class="role-btn active" id="roleCitizen">
        Login as Citizen
        <small>Citizen access with registration</small>
    </button>
    <button class="role-btn" id="roleWard">
        Login as Ward Member
        <small>Ward member access</small>
    </button>
    <button class="role-btn" id="roleAdmin">
        Login as Administration
        <small>Commissioner / Mayor / Deputy Mayor</small>
    </button>
</div>
<div class="overlay" id="overlay"></div>

<div class="card">
    <button class="menu-btn" id="menuBtn" aria-label="Open menu">☰</button>
    <div class="logo-container">
        <img src="/images/municipalLogo.png" alt="Municipal Logo" class="logo">
    </div>
    
    <h2 id="loginTitle">Citizen Login</h2>
    <label id="loginLabel">Please enter your 10-digit phone number<span class="faint">कृपया तुमचा १०-अंकी फोन नंबर एंटर करा</span></label>

    <div class="phone-boxes">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
    </div>
    <div class="status" id="statusMessage"></div>

    <div class="signup-link" id="signupHint">
        Not registered yet? You'll be redirected automatically.
    </div>
</div>

<script>
    const bodyEl = document.body;
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuBtn = document.getElementById('menuBtn');
    const roleCitizen = document.getElementById('roleCitizen');
    const roleWard = document.getElementById('roleWard');
    const roleAdmin = document.getElementById('roleAdmin');
    const loginTitle = document.getElementById('loginTitle');
    const loginLabel = document.getElementById('loginLabel');
    const signupHint = document.getElementById('signupHint');

    function openMenu(){
        sidebar.classList.add('open');
        overlay.classList.add('show');
    }
    function closeMenu(){
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
    }

    function setRole(role){
        bodyEl.classList.remove('role-ward', 'role-admin');

        if(role === 'admin'){
            bodyEl.classList.add('role-admin');
            roleAdmin.classList.add('active');
            roleWard.classList.remove('active');
            roleCitizen.classList.remove('active');
            loginTitle.textContent = 'Administration Login';
            loginLabel.innerHTML = 'Enter registered mobile number <span class="faint">Commissioner / Mayor / Deputy Mayor</span>';
            signupHint.style.display = 'none';
        }else if(role === 'ward'){
            // Ward login is a separate page (username + password)
            window.location.href = '/ward-login';
            return;
        }else{
            roleCitizen.classList.add('active');
            roleWard.classList.remove('active');
            roleAdmin.classList.remove('active');
            loginTitle.textContent = 'Citizen Login';
            loginLabel.innerHTML = 'à¤¦à¤¹à¤¾ à¤…à¤‚à¤•à¥€ à¤«à¥‹à¤¨ à¤¨à¤‚à¤¬à¤° <span class="faint">10-digit phone number</span>';
            signupHint.style.display = 'block';
        }
        closeMenu();
    }

    menuBtn.addEventListener('click', openMenu);
    overlay.addEventListener('click', closeMenu);
    roleCitizen.addEventListener('click', () => setRole('citizen'));
    roleWard.addEventListener('click', () => setRole('ward'));
    roleAdmin.addEventListener('click', () => setRole('admin'));

    const inputs = document.querySelectorAll('.phone-digit');
    const statusMessage = document.getElementById('statusMessage');

    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            // Only allow digits
            input.value = input.value.replace(/[^0-9]/g, '');
            
            // Auto-advance to next box
            if (input.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }

            // Check if all digits are filled
            const allFilled = Array.from(inputs).every(inp => inp.value.length === 1);
            if (allFilled) {
                const phone = Array.from(inputs).map(inp => inp.value).join('');
                checkPhoneAndRedirect(phone);
            }
        });

        input.addEventListener('keydown', (e) => {
            // Handle backspace
            if (e.key === 'Backspace' && input.value === '') {
                if (index > 0) {
                    inputs[index - 1].focus();
                }
            }
        });

        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const digits = paste.replace(/\D/g, '').split('');
            
            digits.forEach((digit, i) => {
                if (i + index < inputs.length) {
                    inputs[i + index].value = digit;
                }
            });

            // Check if all filled after paste
            const allFilled = Array.from(inputs).every(inp => inp.value.length === 1);
            if (allFilled) {
                const phone = Array.from(inputs).map(inp => inp.value).join('');
                checkPhoneAndRedirect(phone);
            }
        });
    });

    async function checkPhoneAndRedirect(phone) {
        statusMessage.textContent = 'Checking...';
        statusMessage.className = 'status loading';

        try {
            const response = await fetch('/check-phone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ phone: phone })
            });

            const data = await response.json();

            if (data.exists) {
                // Phone registered - go to OTP page
                statusMessage.textContent = 'Phone found! Sending OTP...';
                statusMessage.className = 'status success';
                setTimeout(() => {
                    window.location.href = `/otp-page?phone=${phone}`;
                }, 500);
            } else {
                // Phone not registered - go to register page (only for citizen)
                const isCitizen = !bodyEl.classList.contains('role-ward') && !bodyEl.classList.contains('role-admin');
                if (isCitizen) {
                    statusMessage.textContent = 'Redirecting to registration...';
                    statusMessage.className = 'status';
                    setTimeout(() => {
                        window.location.href = `/register?phone=${phone}`;
                    }, 500);
                } else {
                    statusMessage.textContent = 'Not registered. Contact admin for access.';
                    statusMessage.className = 'status error';
                }
            }
        } catch (error) {
            statusMessage.textContent = 'Error checking phone. Please try again.';
            statusMessage.className = 'status error';
            console.error('Error:', error);
        }
    }

    // Auto-focus first input on page load
    window.addEventListener('load', () => {
        inputs[0].focus();
    });
</script>
</body>
</html>
