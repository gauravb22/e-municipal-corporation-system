<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Segoe UI, Arial;
        }
        .card {
            width: 420px;
            background: #fff;
            padding: 28px;
            border-radius: 18px;
            box-shadow: 0 12px 30px rgba(0,0,0,.15);
        }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo {
            height: 60px;
            width: auto;
        }
        h2 {
            text-align: center;
            color: #1e3c72;
            margin-top: 10px;
            margin-bottom: 8px;
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 500;
            color: #333;
            text-align: center;
            font-size: 14px;
        }
        .faint {
            color: #b0b0b0;
            font-weight: 400;
            display: block;
            margin-top: 4px;
        }
        .phone-boxes {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .phone-boxes input {
            width: 32px;
            height: 44px;
            font-size: 18px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .phone-boxes input:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 8px rgba(30, 60, 114, 0.3);
        }
        .status {
            text-align: center;
            font-size: 14px;
            margin-top: 15px;
            min-height: 20px;
        }
        .loading {
            color: #1e3c72;
            font-weight: 500;
        }
        .error {
            color: red;
            font-weight: 500;
        }
        .success {
            color: green;
            font-weight: 500;
        }
        .signup-link {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
        }
        .signup-link a {
            color: #1e3c72;
            text-decoration: none;
        }
        .signup-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="card">
    <div class="logo-container">
        <img src="/images/municipalLogo.png" alt="Municipal Logo" class="logo">
    </div>
    
    <h2>Enter Phone</h2>
    <label>दहा अंकी फोन नंबर <span class="faint">10-digit phone number</span></label>
    
    <div class="phone-boxes">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
        <input type="text" class="phone-digit" maxlength="1" inputmode="numeric" placeholder="0">
    </div>

    <div class="status" id="statusMessage"></div>

    <div class="signup-link">
        Not registered yet? You'll be redirected automatically.
    </div>
</div>

<script>
    const inputs = document.querySelectorAll('.phone-digit');
    const statusMessage = document.getElementById('statusMessage');

    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            // Only allow digits
            input.value = input.value.replace(/[^0-9]/g, '');
            
            // Auto-advance to next box
            if (input.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }

            // Check if all digits are filled
            const allFilled = Array.from(inputs).every(inp => inp.value.length === 1);
            if (allFilled) {
                const phone = Array.from(inputs).map(inp => inp.value).join('');
                checkPhoneAndRedirect(phone);
            }
        });

        input.addEventListener('keydown', (e) => {
            // Handle backspace
            if (e.key === 'Backspace' && input.value === '') {
                if (index > 0) {
                    inputs[index - 1].focus();
                }
            }
        });

        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const digits = paste.replace(/\D/g, '').split('');
            
            digits.forEach((digit, i) => {
                if (i + index < inputs.length) {
                    inputs[i + index].value = digit;
                }
            });

            // Check if all filled after paste
            const allFilled = Array.from(inputs).every(inp => inp.value.length === 1);
            if (allFilled) {
                const phone = Array.from(inputs).map(inp => inp.value).join('');
                checkPhoneAndRedirect(phone);
            }
        });
    });

    async function checkPhoneAndRedirect(phone) {
        statusMessage.textContent = 'Checking...';
        statusMessage.className = 'status loading';

        try {
            const response = await fetch('/check-phone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ phone: phone })
            });

            const data = await response.json();

            if (data.exists) {
                // Phone registered - go to OTP page
                statusMessage.textContent = 'Phone found! Sending OTP...';
                statusMessage.className = 'status success';
                setTimeout(() => {
                    window.location.href = `/otp-page?phone=${phone}`;
                }, 500);
            } else {
                // Phone not registered - go to register page
                statusMessage.textContent = 'Redirecting to registration...';
                statusMessage.className = 'status';
                setTimeout(() => {
                    window.location.href = `/register?phone=${phone}`;
                }, 500);
            }
        } catch (error) {
            statusMessage.textContent = 'Error checking phone. Please try again.';
            statusMessage.className = 'status error';
            console.error('Error:', error);
        }
    }

    // Auto-focus first input on page load
    window.addEventListener('load', () => {
        inputs[0].focus();
    });
</script>
</body>
</html>

<script>
    const inputs = document.querySelectorAll('.phone-digit');
    const statusMessage = document.getElementById('statusMessage');

    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            // Only allow digits
            input.value = input.value.replace(/[^0-9]/g, '');
            
            // Auto-advance to next box
            if (input.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }

            // Check if all digits are filled
            const allFilled = Array.from(inputs).every(inp => inp.value.length === 1);
            if (allFilled) {
                const phone = Array.from(inputs).map(inp => inp.value).join('');
                checkPhoneAndRedirect(phone);
            }
        });

        input.addEventListener('keydown', (e) => {
            // Handle backspace
            if (e.key === 'Backspace' && input.value === '') {
                if (index > 0) {
                    inputs[index - 1].focus();
                }
            }
        });

        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const digits = paste.replace(/\D/g, '').split('');
            
            digits.forEach((digit, i) => {
                if (i + index < inputs.length) {
                    inputs[i + index].value = digit;
                }
            });

            // Check if all filled after paste
            const allFilled = Array.from(inputs).every(inp => inp.value.length === 1);
            if (allFilled) {
                const phone = Array.from(inputs).map(inp => inp.value).join('');
                checkPhoneAndRedirect(phone);
            }
        });
    });

    async function checkPhoneAndRedirect(phone) {
        statusMessage.textContent = 'Checking...';
        statusMessage.className = 'status loading';

        try {
            const response = await fetch('/check-phone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ phone: phone })
            });

            const data = await response.json();

            if (data.exists) {
                // Phone registered - go to OTP page
                statusMessage.textContent = 'Phone found! Sending OTP...';
                statusMessage.className = 'status success';
                setTimeout(() => {
                    window.location.href = `/otp-page?phone=${phone}`;
                }, 500);
            } else {
                // Phone not registered - go to register page
                statusMessage.textContent = 'Phone not registered. Redirecting to registration...';
                statusMessage.className = 'status';
                setTimeout(() => {
                    window.location.href = `/register?phone=${phone}`;
                }, 500);
            }
        } catch (error) {
            statusMessage.textContent = 'Error checking phone. Please try again.';
            statusMessage.className = 'status error';
            console.error('Error:', error);
        }
    }

    // Auto-focus first input on page load
    window.addEventListener('load', () => {
        inputs[0].focus();
    });
</script>
</body>
</html>
