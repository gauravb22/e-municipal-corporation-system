<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Complaint Details</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{margin:0;font-family:"Segoe UI", Arial;background:linear-gradient(135deg,#0f3d2e,#2e8b57);min-height:100vh;}
.topbar{background:#123a2b;color:white;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;}
.brand{display:flex;align-items:center;gap:12px;}
.brand img{width:44px;height:44px;}
.brand-title{font-weight:700;}
.brand-sub{font-size:12px;opacity:.85;}
.container{max-width:900px;margin:24px auto;padding:12px;}
.card{background:white;border-radius:14px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.18);}
.title{font-size:20px;font-weight:700;color:#123a2b;}
.badge{display:inline-block;padding:4px 8px;border-radius:10px;font-size:12px;font-weight:600;margin-left:8px;}
.badge.submitted{background:#fff1d6;color:#9a6b10;}
.badge.assigned{background:#e8f0ff;color:#1e3c72;}
.badge.approved{background:#e8f7ee;color:#1f6f4a;}
.badge.in-progress{background:#e6f4ff;color:#155a8a;}
.badge.completed{background:#d4edda;color:#155724;}
.badge.verified{background:#e3fcec;color:#1f6f4a;}
.badge.overdue{background:#ffe7e7;color:#b42318;}
.badge.repeated{background:#fbe9e7;color:#b23a1b;}
.badge.not-ward{background:#f1f3f5;color:#4b5563;}
.badge.wrong{background:#fdecec;color:#b53838;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
.item{background:#f8f9fa;border-radius:10px;padding:10px;}
.label{font-size:12px;color:#666;text-transform:uppercase;}
.value{font-weight:600;color:#1e3c72;margin-top:4px;word-break:break-word;}
.value a{color:#1e3c72;text-decoration:none;}
.value a:hover{text-decoration:underline;}
.citizen-profile{display:flex;align-items:center;gap:10px;margin-top:8px;}
.citizen-avatar{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid #e5e7eb;background:#fff;}
.citizen-name{font-size:14px;font-weight:700;color:#1e3c72;}
.citizen-phone{font-size:12px;color:#5f6b75;margin-top:2px;}
.desc{margin-top:12px;font-size:14px;color:#444;line-height:1.4;}
.photo{margin-top:12px;max-width:100%;border-radius:10px;border:1px solid #e5e7eb;}
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px;}
.btn{border:none;border-radius:10px;padding:10px 12px;font-size:12px;cursor:pointer;font-weight:600;}
.btn-assign{background:#1e3c72;color:white;}
.btn-approve{background:#1f6f4a;color:white;}
.btn-progress{background:#155a8a;color:white;}
.btn-repeated{background:#b23a1b;color:white;}
.btn-notward{background:#4b5563;color:white;}
.btn-wrong{background:#b53838;color:white;}
.notice{margin-top:12px;font-size:13px;color:#555;}
@media (max-width:720px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="topbar">
    <div class="brand">
        <img th:src="${staffUser != null && staffUser.photoBase64 != null ? staffUser.photoBase64 : '/images/municipalLogo.png'}" alt="Logo">
        <div>
            <div class="brand-title">Akola Mahanagarpalika</div>
            <div class="brand-sub">Complaint Details</div>
        </div>
    </div>
    <a href="/ward-complaints" style="color:white;text-decoration:none;">Back</a>
</div>

<div class="container">
    <div class="card">
        <div class="title">
            <span th:text="${complaint.complaintType}">Complaint</span>
            <span class="badge submitted" th:if="${complaint.status == 'submitted' || complaint.status == 'pending'}">SUBMITTED</span>
            <span class="badge assigned" th:if="${complaint.status == 'assigned'}">ASSIGNED</span>
            <span class="badge approved" th:if="${complaint.status == 'approved'}">APPROVED</span>
            <span class="badge in-progress" th:if="${complaint.status == 'in_progress'}">IN PROGRESS</span>
            <span class="badge overdue" th:if="${complaint.status == 'overdue'}">OVERDUE</span>
            <span class="badge completed" th:if="${complaint.status == 'completed' || complaint.status == 'solved'}">COMPLETED</span>
            <span class="badge verified" th:if="${complaint.status == 'verified'}">VERIFIED</span>
            <span class="badge repeated" th:if="${complaint.status == 'repeated'}">REPEATED</span>
            <span class="badge not-ward" th:if="${complaint.status == 'not_ward'}">NOT OUR WARD</span>
            <span class="badge wrong" th:if="${complaint.status == 'wrong'}">WRONG</span>
        </div>

        <div class="grid">  
            <div class="item">
                <div class="label">Citizen</div>
                <div class="citizen-profile">
                    <img class="citizen-avatar"
                         th:src="${citizen != null && citizen.photoBase64 != null && !#strings.isEmpty(citizen.photoBase64) ? (#strings.startsWith(citizen.photoBase64, 'data:') ? citizen.photoBase64 : ('data:image/jpeg;base64,' + citizen.photoBase64)) : '/images/municipalLogo.png'}"
                         alt="Citizen photo">
                    <div>
                        <div class="citizen-name" th:text="${citizen != null && citizen.fullName != null ? citizen.fullName : 'Unknown Citizen'}">Citizen Name</div>
                        <div class="citizen-phone" th:text="${citizen != null && citizen.phone != null ? citizen.phone : 'Unknown'}">Phone</div>
                    </div>
                </div>
            </div>
            <div class="item">
                <div class="label">House No</div>
                <div class="value" th:text="${complaint.houseNo}">House</div>
            </div>
            <div class="item">
                <div class="label">Location</div>
                <div class="value">
                    <a th:if="${complaint.photoLatitude != null && complaint.photoLongitude != null && complaint.photoLatitude != '0' && complaint.photoLongitude != '0'}"
                       th:href="'https://www.google.com/maps?q=' + ${complaint.photoLatitude} + ',' + ${complaint.photoLongitude}"
                       target="_blank" rel="noopener"
                       th:text="${complaint.location}">Location</a>
                    <span th:if="${complaint.photoLatitude == null || complaint.photoLongitude == null || complaint.photoLatitude == '0' || complaint.photoLongitude == '0'}"
                          th:text="${complaint.location}">Location</span>
                </div>
            </div>
            <div class="item">
                <div class="label">Ward No</div>
                <div class="value" th:text="${complaint.wardNo}">Ward</div>
            </div>
            <div class="item">
                <div class="label">Ward Zone</div>
                <div class="value" th:text="${complaint.wardZone}">Zone</div>
            </div>
            <div class="item">
                <div class="label">Submitted At</div>
                <div class="value" th:text="${#temporals.format(complaint.createdAt, 'dd-MMM-yyyy HH:mm')}">Date</div>
            </div>
            <div class="item">
                <div class="label">Complaint ID</div>
                <div class="value" th:text="${complaint.id}">ID</div>
            </div>
            <div class="item" th:if="${complaint.notComingFromDate != null}">
                <div class="label">Not Coming From</div>
                <div class="value" th:text="${#temporals.format(complaint.notComingFromDate, 'dd-MMM-yyyy')}">Date</div>
            </div>
        </div>

        <div class="desc" th:if="${complaint.description != null}">
            <strong>Details:</strong> <span th:text="${complaint.description}"></span>
        </div>

        <div class="grid" style="margin-top:12px;" th:if="${complaint.photoPath != null || complaint.photoBase64 != null || complaint.donePhotoPath != null || complaint.donePhotoBase64 != null}">
            <div class="item" th:if="${complaint.photoPath != null || complaint.photoBase64 != null}">
                <div class="label">Before Photo</div>
                <img th:src="${complaint.photoPath != null ? complaint.photoPath : complaint.photoBase64}" class="photo" alt="Complaint photo">
            </div>
            <div class="item" th:if="${complaint.donePhotoPath != null || complaint.donePhotoBase64 != null}">
                <div class="label">After Photo</div>
                <img th:src="${complaint.donePhotoPath != null ? complaint.donePhotoPath : complaint.donePhotoBase64}" class="photo" alt="Completion photo">
            </div>
        </div>

        <div class="actions" th:if="${complaint.status == 'submitted' || complaint.status == 'pending' || complaint.status == 'overdue'}">
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="assigned">
                <button class="btn btn-assign" type="submit">Assign to Ward</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="not_ward">
                <button class="btn btn-notward" type="submit">Not Our Ward</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="wrong">
                <button class="btn btn-wrong" type="submit">Wrong</button>
            </form>
        </div>

        <div class="actions" th:if="${complaint.status == 'assigned'}">
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="approved">
                <button class="btn btn-approve" type="submit">Approve</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="repeated">
                <button class="btn btn-repeated" type="submit">Repeated</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="not_ward">
                <button class="btn btn-notward" type="submit">Not Our Ward</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="wrong">
                <button class="btn btn-wrong" type="submit">Wrong</button>
            </form>
        </div>

        <div class="actions" th:if="${complaint.status == 'approved'}">
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="in_progress">
                <button class="btn btn-progress" type="submit">Start Work</button>
            </form>
        </div>

        <div class="actions" th:if="${complaint.status == 'in_progress'}">
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/complete'" id="completeForm" enctype="multipart/form-data">
                <div class="item" style="width:100%;">
                    <div class="label">Completion Photo (Required)</div>
                    <div style="margin-top:8px;">
                        <button class="btn btn-progress" type="button" onclick="captureDonePhoto()">Capture Photo</button>
                    </div>
                    <img id="donePhotoPreview" class="photo" style="display:none;" alt="Completed work photo">
                    <div class="notice" id="donePhotoCapturedMsg" style="display:none;">Photo captured with timestamp and location.</div>
                    <input type="file" id="donePhotoInput" name="donePhoto" accept=".jpg,.jpeg,image/jpeg" capture="environment" style="display:none;" onchange="handleDonePhotoCapture(event)">
                    <input type="hidden" id="donePhotoTimestamp" name="donePhotoTimestamp">
                    <input type="hidden" id="donePhotoLocation" name="donePhotoLocation">
                    <input type="hidden" id="donePhotoLatitude" name="donePhotoLatitude">
                    <input type="hidden" id="donePhotoLongitude" name="donePhotoLongitude">
                </div>
                <button class="btn btn-progress" type="submit" id="markDoneBtn" style="margin-top:10px;" disabled>Mark as Completed</button>
            </form>
        </div>

        <div class="notice" th:if="${complaint.status == 'completed' || complaint.status == 'verified' || complaint.status == 'solved'}">This complaint is completed.</div>
    </div>
</div>

<script>
function isJpgFile(file) {
    const type = (file.type || '').toLowerCase();
    const name = (file.name || '').toLowerCase();
    return type === 'image/jpeg' || type === 'image/jpg' || name.endsWith('.jpg') || name.endsWith('.jpeg');
}

function captureDonePhoto() {
    document.getElementById('donePhotoInput').click();
}

function handleDonePhotoCapture(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }
    if (!isJpgFile(file)) {
        event.target.value = '';
        alert('Only JPG format is allowed for completion photo.');
        return;
    }

    const preview = document.getElementById('donePhotoPreview');
    preview.src = URL.createObjectURL(file);
    preview.style.display = 'block';
    document.getElementById('donePhotoCapturedMsg').style.display = 'block';
    document.getElementById('markDoneBtn').disabled = false;

    const now = new Date();
    document.getElementById('donePhotoTimestamp').value = now.toISOString();

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude.toFixed(6);
                const lon = position.coords.longitude.toFixed(6);
                document.getElementById('donePhotoLatitude').value = lat;
                document.getElementById('donePhotoLongitude').value = lon;
                document.getElementById('donePhotoLocation').value = `${lat}, ${lon}`;
            },
            function() {
                document.getElementById('donePhotoLocation').value = 'Location not available';
            }
        );
    } else {
        document.getElementById('donePhotoLocation').value = 'Location not available';
    }
}

const completeForm = document.getElementById('completeForm');
if (completeForm) {
    completeForm.addEventListener('submit', function(e) {
        const input = document.getElementById('donePhotoInput');
        if (!input || !input.files || input.files.length === 0) {
            e.preventDefault();
            alert('Please capture a completion photo before marking as done.');
        }
    });
}
</script>
</body>
</html>
