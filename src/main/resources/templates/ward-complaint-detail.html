<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Complaint Details</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{margin:0;font-family:"Segoe UI", Arial;background:linear-gradient(135deg,#0f3d2e,#2e8b57);min-height:100vh;}
.topbar{background:#123a2b;color:white;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;}
.brand{display:flex;align-items:center;gap:12px;}
.brand img{width:44px;height:44px;}
.brand-title{font-weight:700;}
.brand-sub{font-size:12px;opacity:.85;}
.container{max-width:900px;margin:24px auto;padding:12px;}
.card{background:white;border-radius:14px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.18);}
.title{font-size:20px;font-weight:700;color:#123a2b;}
.badge{display:inline-block;padding:4px 8px;border-radius:10px;font-size:12px;font-weight:600;margin-left:8px;}
.badge.pending{background:#fff1d6;color:#9a6b10;}
.badge.approved{background:#e8f7ee;color:#1f6f4a;}
.badge.solved{background:#e6f4ff;color:#155a8a;}
.badge.repeated{background:#fbe9e7;color:#b23a1b;}
.badge.not-ward{background:#f1f3f5;color:#4b5563;}
.badge.wrong{background:#fdecec;color:#b53838;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
.item{background:#f8f9fa;border-radius:10px;padding:10px;}
.label{font-size:12px;color:#666;text-transform:uppercase;}
.value{font-weight:600;color:#1e3c72;margin-top:4px;word-break:break-word;}
.value a{color:#1e3c72;text-decoration:none;}
.value a:hover{text-decoration:underline;}
.desc{margin-top:12px;font-size:14px;color:#444;line-height:1.4;}
.photo{margin-top:12px;max-width:100%;border-radius:10px;border:1px solid #e5e7eb;}
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px;}
.btn{border:none;border-radius:10px;padding:10px 12px;font-size:12px;cursor:pointer;font-weight:600;}
.btn-approve{background:#1f6f4a;color:white;}
.btn-solved{background:#155a8a;color:white;}
.btn-repeated{background:#b23a1b;color:white;}
.btn-notward{background:#4b5563;color:white;}
.btn-wrong{background:#b53838;color:white;}
.notice{margin-top:12px;font-size:13px;color:#555;}
@media (max-width:720px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="topbar">
    <div class="brand">
        <img src="/images/municipalLogo.png" alt="Logo">
        <div>
            <div class="brand-title">Akola Mahanagarpalika</div>
            <div class="brand-sub">Complaint Details</div>
        </div>
    </div>
    <a href="/ward-complaints" style="color:white;text-decoration:none;">Back</a>
</div>

<div class="container">
    <div class="card">
        <div class="title">
            <span th:text="${complaint.complaintType}">Complaint</span>
            <span class="badge pending" th:if="${complaint.status == 'pending'}">PENDING</span>
            <span class="badge approved" th:if="${complaint.status == 'approved'}">APPROVED</span>
            <span class="badge solved" th:if="${complaint.status == 'solved'}">SOLVED</span>
            <span class="badge repeated" th:if="${complaint.status == 'repeated'}">REPEATED</span>
            <span class="badge not-ward" th:if="${complaint.status == 'not_ward'}">NOT OUR WARD</span>
            <span class="badge wrong" th:if="${complaint.status == 'wrong'}">WRONG</span>
        </div>

        <div class="grid">  
            <div class="item">
                <div class="label">Citizen Name</div>
                <div class="value" th:text="${citizen != null ? citizen.fullName : 'Unknown'}">Citizen Name</div>
            </div>
            <div class="item">
                <div class="label">Phone</div>
                <div class="value" th:text="${citizen != null ? citizen.phone : 'Unknown'}">Phone</div>
            </div>
            <div class="item">
                <div class="label">House No</div>
                <div class="value" th:text="${complaint.houseNo}">House</div>
            </div>
            <div class="item">
                <div class="label">Location</div>
                <div class="value">
                    <a th:href="'https://www.google.com/maps?q=' + ${complaint.photoLatitude} + ',' + ${complaint.photoLongitude}"
                       target="_blank" rel="noopener"
                       th:text="${complaint.location}">Location</a>
                </div>
            </div>
            <div class="item">
                <div class="label">Ward No</div>
                <div class="value" th:text="${complaint.wardNo}">Ward</div>
            </div>
            <div class="item">
                <div class="label">Ward Zone</div>
                <div class="value" th:text="${complaint.wardZone}">Zone</div>
            </div>
            <div class="item">
                <div class="label">Submitted At</div>
                <div class="value" th:text="${#temporals.format(complaint.createdAt, 'dd-MMM-yyyy HH:mm')}">Date</div>
            </div>
            <div class="item">
                <div class="label">Complaint ID</div>
                <div class="value" th:text="${complaint.id}">ID</div>
            </div>
        </div>

        <div class="desc" th:if="${complaint.description != null}">
            <strong>Details:</strong> <span th:text="${complaint.description}"></span>
        </div>

        <img th:if="${complaint.photoBase64 != null}" th:src="${complaint.photoBase64}" class="photo" alt="Complaint photo">

        <div class="actions" th:if="${complaint.status != 'approved' and complaint.status != 'solved'}">
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="approved">
                <button class="btn btn-approve" type="submit">Approve</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="solved">
                <button class="btn btn-solved" type="submit">Already Done</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="repeated">
                <button class="btn btn-repeated" type="submit">Repeated</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="not_ward">
                <button class="btn btn-notward" type="submit">Not Our Ward</button>
            </form>
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/status'">
                <input type="hidden" name="status" value="wrong">
                <button class="btn btn-wrong" type="submit">Wrong</button>
            </form>
        </div>

        <div class="actions" th:if="${complaint.status == 'approved'}">
            <form method="post" th:action="'/ward-complaints/' + ${complaint.id} + '/complete'" id="completeForm">
                <div class="item" style="width:100%;">
                    <div class="label">Completion Photo (Required)</div>
                    <div style="margin-top:8px;">
                        <button class="btn btn-solved" type="button" onclick="captureDonePhoto()">Capture Photo</button>
                    </div>
                    <img id="donePhotoPreview" class="photo" style="display:none;" alt="Completed work photo">
                    <div class="notice" id="donePhotoCapturedMsg" style="display:none;">Photo captured with timestamp and location.</div>
                    <input type="file" id="donePhotoInput" accept="image/*" capture="environment" style="display:none;" onchange="handleDonePhotoCapture(event)">
                    <input type="hidden" id="donePhotoTimestamp" name="donePhotoTimestamp">
                    <input type="hidden" id="donePhotoLocation" name="donePhotoLocation">
                    <input type="hidden" id="donePhotoLatitude" name="donePhotoLatitude">
                    <input type="hidden" id="donePhotoLongitude" name="donePhotoLongitude">
                    <input type="hidden" id="donePhotoBase64" name="donePhotoBase64">
                </div>
                <button class="btn btn-solved" type="submit" id="markDoneBtn" style="margin-top:10px;" disabled>Mark as Done</button>
            </form>
        </div>

        <div class="notice" th:if="${complaint.status == 'solved'}">This complaint is already completed.</div>
    </div>
</div>

<script>
function captureDonePhoto() {
    document.getElementById('donePhotoInput').click();
}

function handleDonePhotoCapture(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('donePhotoPreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('donePhotoCapturedMsg').style.display = 'block';
        document.getElementById('donePhotoBase64').value = e.target.result;
        document.getElementById('markDoneBtn').disabled = false;
    };
    reader.readAsDataURL(file);

    const now = new Date();
    document.getElementById('donePhotoTimestamp').value = now.toISOString();

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude.toFixed(6);
                const lon = position.coords.longitude.toFixed(6);
                document.getElementById('donePhotoLatitude').value = lat;
                document.getElementById('donePhotoLongitude').value = lon;
                document.getElementById('donePhotoLocation').value = `${lat}, ${lon}`;
            },
            function() {
                document.getElementById('donePhotoLocation').value = 'Location not available';
            }
        );
    } else {
        document.getElementById('donePhotoLocation').value = 'Location not available';
    }
}

const completeForm = document.getElementById('completeForm');
if (completeForm) {
    completeForm.addEventListener('submit', function(e) {
        if (!document.getElementById('donePhotoBase64').value) {
            e.preventDefault();
            alert('Please capture a completion photo before marking as done.');
        }
    });
}
</script>
</body>
</html>
